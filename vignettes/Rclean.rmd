---
title: "Rclean"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Rclean}
  %\VignetteEncoding{UTF-8}
---

<!-- \VignetteEngine{knitr::knitr} -->
<!-- https://bookdown.org/yihui/rmarkdown/r-package-vignette.html -->

### Topics
### Quick-start: basic workflow example
### Refactoring issues
    ## 1 R's analytical focus
    ## 2 Largely non-CS
    ## 3 
### Provenance
    ## 1 Why?
    ## 2 What is it?
    ## 3 Prosepctive and retrospective
    ## 4 CodeDepends
    ## 5 Other projects
### How variables are isolated
    ## 1 Single variable selection
    ## 2 How multiple variables are isolated
### More complicated script example
### Applied to Drake
    

Clean up your code
==================

- [Rclean](https://github.com/ProvTools/Rclean) was created to help
  scientists more *easily* write "cleaner" code. 
- Written with research scientists that are results oriented in mind,
  the package's primary function provides a simple way to isolate the
  minimal code you need to produce a specific result, such as a
  statistical table or a figure.
- By focusing on specific results, large and/or complicated analytical
  scripts can be paired down to the essentials and easily re-factored
  to be more robust and easily shared.

Install
=======

You can install
[Rclean](https://cran.r-project.org/web/packages/Rclean/) from *CRAN*: 

```{r eval = FALSE}
install.packages("Rclean")
```

You can install the most up to date version easily with
[devtools](https://github.com/hadley/devtools):

```{r eval = FALSE}
install.packages("devtools")
devtools::install_github("MKLau/Rclean")
```

Once installed, per usual R practice, just load the *Rclean* package with:

```{r eval = TRUE}
library(Rclean)
```

Usage
=====

```{r eval = TRUE, echo = FALSE, results = "hide"}
library(CodeDepends)
script <- system.file(
    "example", 
    "simple_script.R", 
    package = "Rclean")

```

*Rclean* usage is simple. Have a script with code you want to clean
saved to disk. Then, just run the `clean` function with the path to
the script as the input. Here, we can use an example script that is
included with the package:

```{r eval = FALSE} 
script <- "example/simple_script.R"

```

Here's a quick look at the code:


```{r eval = TRUE}
readLines(script)

```



You can get a list of the variables found in an object with
`get_vars`. 

```{r eval = TRUE}
get_vars(script)

```

Sometimes for more complicated scripts, it can be helpful to see a
 network graph showing the interdependencies of
 variables. `code_graph` will produce a network diagram showing which
 lines of code produce or use which variables (e.g. 1 -> "out"):

```{r eval = TRUE}
code_graph(script)
```

Now, we can pick the result we want to focus on for cleaning:


```{r eval = TRUE}
clean(script, "tab.15")
```

We can also select several variables at the same time:

```{r eval = TRUE}
my.vars <- c("tab.12", "tab.15")
clean(script, my.vars)
```

While just taking a look at the simplified code can be very helpful,
you can also save the code for later use or sharing (e.g. creating a
reproducible example for getting help) with `keep`:

```{r eval = FALSE}
my.code <- clean(script, my.vars)
keep(my.code, file = "results_tables.R")
```

If you would like to copy your code to your clipboard, you can do that
by not specifying a file path. You can now paste the simplified as needed.

```{r eval = FALSE}
keep(my.code)
```



Contributing
============

This is an open-source project. If you would like to contribute to the
project, please check out [CONTRIBUTING.md](CONTRIBUTING.md).

Please note that the 'Rclean' project is released with a
[Contributor Code of Conduct](CODE_OF_CONDUCT.md).
By contributing to this project, you agree to abide by its terms.



## # Clean up your code

## - Have you ever written a long script in R that conducts lots of
##   analyses and wished that someone would come along and make it all
##   clearer to understand and use?
## - Well youâ€™re not alone. 
## - A recent survey of over 1500 scientists reported a crisis of
##   reproducibility with "selective reporting" being the most cited
##   contributing factor and 80% saying code availability is playing a
##   role.
## - [Rclean](https://github.com/ProvTools/Rclean) was created to help
##   scientists more *easily* write "cleaner" code by providing a simple,
##   rigorous way to isolate the minimal code you need in order to
##   produce a specific result (e.g. object, plot, output written to
##   disk).
## - [Rclean](https://github.com/ProvTools/Rclean) is built on data
##   provenance, a formal representation of a computation, and uses graph
##   analysis to determine the minimal path from inputs to results.
## - The goal is to help facilitate code transparency, reproducibility,
##   reusability and ultimately help scientists spend more time on
##   research and less time on software. 

## # Install


## You can install
## [Rclean](https://cran.r-project.org/web/packages/Rclean/) from *CRAN*: 

## ```{r eval = FALSE}
## install.packages("Rclean")
## ```

## You can install the most up to date (beta) version easily with
## [devtools](https://github.com/hadley/devtools):

## ```{r eval = FALSE}
## install.packages("devtools")
## devtools::install_github("ProvTools/Rclean", ref = "dev")
## ```


## Once installed, per usual R practice, just load the *Rclean*:

## ```{r eval = TRUE}
## library(Rclean)
## ```

## # Usage


## *Rclean* usage is simple. Have a script with code you want to clean
## saved to disk. Then, just run the `clean` function with the path to
## the script as the input. Here, we can use an example script that is
## included with the package:

## ```{r eval = TRUE}
## clean("example/simple_script.R")
## ```

## This returns a list of possible results detected in the script,
## including execution lines (not counting lines with no code or that are
## commented). We can now pick the result we want to focus on for
## cleaning: 


## ```{r eval = TRUE}
## clean("./example/simple_script.R", "tab.15")
## ```

## This produces the minimal code detected from the script. It also
## detects library dependencies and inserts them into the code (`libs =
## TRUE`).

## It can be handy just to take a look at the isolated code, but you can
## save the code for later use or sharing (e.g. creating a reproducible
## example for getting help) with the `write.code` function:

## ```{r eval = FALSE}
## my.code <- clean("example/simple_script.R", "tab.15")
## write.code(my.code, file = "x.R")
## ```

## If you would like to copy your code to your clipboard, you can do that
## by not specifying a file path. You can now paste as needed to create a
## simpler script.

## ```{r eval = FALSE}
## write.code(my.code)
## ```



## ## Retrospective Provenance

## So far, we've been using "prospective" provenance generated from the
## static code prior to execution. *Rclean* can also be used with
## "retrospective" provenance, which is recorded during execution of a
## script. Using it facilitates more accurate code cleaning, We can pass
## the provenance to the `clean` function via `options`:


## ```{r eval = TRUE}
## options(prov.json = readLines("example/prov_micro.json"))
## ```

## Now that we have the provenance loaded, we can start
## cleaning. [Rclean](https://github.com/ProvTools/Rclean) will give us a
## list of possible values we can get code for, notice that the option
## *rp* (i.e. "retrospective provenance") has been set to `TRUE`:

## ```{r eval = TRUE}
## clean(file = "example/micro.R", rp = TRUE)
## ```

## Similar to before, you can then pick and choose from among these
## results and get the essential code to produce the output, like so:

## ```{r eval = TRUE}
## clean(file = "example/micro.R", var = "x", rp = TRUE)
## ```

## Happy cleaning!

